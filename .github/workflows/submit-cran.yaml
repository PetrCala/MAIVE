# Manual workflow for CRAN submission
# This workflow performs pre-submission checks and provides guidance for final submission
name: Submit to CRAN

on:
  workflow_dispatch:
    inputs:
      confirmation:
        description: 'Type "CONFIRM" to proceed with CRAN submission checks'
        required: true
        default: ""
        type: string

permissions: read-all

jobs:
  cran-submission:
    runs-on: ubuntu-latest

    name: CRAN Pre-Submission Checks

    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      R_KEEP_PKG_SOURCE: yes

    steps:
      - name: Verify confirmation
        run: |
          if [ "${{ github.event.inputs.confirmation }}" != "CONFIRM" ]; then
            echo "‚ùå Confirmation not provided. Please type 'CONFIRM' to proceed."
            exit 1
          fi
          echo "‚úÖ Confirmation received. Proceeding with CRAN checks..."

      - uses: actions/checkout@v4

      - uses: r-lib/actions/setup-pandoc@v2

      - uses: r-lib/actions/setup-r@v2
        with:
          r-version: "release"
          use-public-rspm: true

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: |
            any::rcmdcheck
            any::rhub
            any::devtools
          needs: check

      - name: Build package
        run: |
          echo "üì¶ Building package tarball..."
          R CMD build .
        shell: bash

      - name: Run R CMD check --as-cran
        run: |
          echo "üîç Running R CMD check --as-cran..."
          tarball <- list.files(pattern = "\\.tar\\.gz$", full.names = TRUE)
          rcmdcheck::rcmdcheck(
            tarball,
            args = c("--as-cran", "--no-manual"),
            error_on = "warning",
            check_dir = "check"
          )
        shell: Rscript {0}

      - name: Check on Windows (via R-hub)
        run: |
          echo "ü™ü Submitting checks to R-hub for Windows..."
          rhub::rhub_check(platforms = "windows")
        shell: Rscript {0}
        continue-on-error: true

      - name: Check on other platforms (via R-hub)
        run: |
          echo "üåç Submitting checks to R-hub for additional platforms..."
          rhub::rhub_check(platforms = c("linux", "macos"))
        shell: Rscript {0}
        continue-on-error: true

      - name: Upload check results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cran-check-results
          path: check/

      - name: Submission instructions
        if: success()
        run: |
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë                  ‚úÖ CRAN CHECKS PASSED                         ‚ïë"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          echo ""
          echo "üìã Next steps for CRAN submission:"
          echo ""
          echo "1. Review the check results in the artifacts above"
          echo "2. Review R-hub results (check your email or R-hub dashboard)"
          echo "3. Update cran-comments.md with any notes"
          echo "4. To submit to CRAN, run locally:"
          echo "   devtools::submit_cran()"
          echo ""
          echo "5. Alternatively, use the helper script:"
          echo "   Rscript scripts/submit-cran.R"
          echo ""
          echo "6. Watch for CRAN email confirmation and respond promptly"
          echo ""
          echo "‚ö†Ô∏è  Remember: You must confirm the submission via email!"
          echo ""
        shell: bash
